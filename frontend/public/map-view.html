<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Geo-Spatial Map for Document Discovery</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100%;
            z-index: 10;
            background-color: #f0f4f8;
        }
        
        /* --- Enhanced Map Visuals --- */
        .station-icon {
            background-color: white;
            border: 3px solid #005a9c; /* Dark blue border */
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            width: 20px !important;
            height: 20px !important;
            transition: all 0.2s ease;
        }
        .station-icon.active-station-icon {
            border-color: #ff4d4d; /* Bright red for active */
            transform: scale(1.2);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 77, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); }
        }
        .station-icon.active-station-icon::after {
            content: '';
            position: absolute;
            top: -5px; left: -5px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            z-index: -1;
        }
        
        /* New reliable Font Awesome train icon style */
        .train-fa-icon .fa-train-tram {
            font-size: 32px;
            color: #2c3e50;
            line-height: 1;
            text-shadow: 3px 3px 5px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%);
        }
        
        .leaflet-popup-content-wrapper { background: #fff; color: #333; }
        .leaflet-popup-tip { background: #fff; }
        .leaflet-popup-content { font-weight: 600; }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }

        /* Modal animation */
        .modal-hidden { visibility: hidden; opacity: 0; transition: visibility 0s 0.3s, opacity 0.3s ease; }
        .modal-visible { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
        .modal-content { transform: scale(0.95) translateY(20px); transition: transform 0.3s ease; }
        .modal-visible .modal-content { transform: scale(1) translateY(0); }
        
        /* Details dropdown transition */
        details[open] summary ~ * { animation: sweep .5s ease-in-out; }
        @keyframes sweep {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-200">

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Map Section -->
        <div class="w-full md:w-2/3 h-1/2 md:h-full relative shadow-lg">
            <div id="map"></div>
            <div id="controls" class="absolute bottom-5 left-1/2 -translate-x-1/2 z-20 bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-2xl flex items-center gap-3">
                <button id="toggle-train-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all shadow-md flex items-center gap-2 w-44 justify-center">
                    <i id="train-btn-icon" class="fa-solid fa-play w-5 text-center"></i>
                    <span id="train-btn-text">Start Simulation</span>
                </button>
                <button id="reset-view-btn" class="p-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all shadow-md" title="Reset View">
                    <i class="fa-solid fa-arrows-rotate w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Document Section -->
        <div class="w-full md:w-1/3 h-1/2 md:h-full bg-gray-50 flex flex-col">
            <div id="side-panel-header" class="p-5 bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-md z-10 shrink-0">
                <!-- Header content is now dynamic -->
            </div>
            <div id="side-panel-content" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                <!-- Content is now dynamic -->
            </div>
        </div>
    </div>
    
    <!-- Document Viewer Modal -->
    <div id="document-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div id="modal-overlay" class="absolute inset-0"></div>
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col relative">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800"></h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>

    <script>
        // --- MOCK DATA ---
        const longContent = {
            report: `<p class="mb-4 text-gray-700 leading-relaxed">This comprehensive report outlines the critical assessment of flood preparedness protocols for the Aluva station, a key transit hub situated in a region susceptible to seasonal monsoons. The analysis covers historical data from the 2018 Kerala floods, evaluating the station's structural resilience, drainage system efficacy, and emergency response mechanisms. Our findings indicate that while significant improvements have been made, several areas require immediate attention.</p><p class="mb-4 text-gray-700 leading-relaxed">The station's primary drainage channels, while expanded, show early signs of silt accumulation, reducing their maximum discharge capacity by an estimated 15%. We recommend a quarterly desilting schedule, particularly pre-monsoon, to mitigate this risk. Furthermore, the elevation of critical electrical equipment, including signaling systems and backup generators, remains below the recommended 2-meter mark above the highest recorded flood level. A phased project to relocate these assets is detailed in Appendix A, with a projected budget of ₹1.2 Crore.</p><p class="mb-4 text-gray-700 leading-relaxed">Evacuation procedures were tested via simulation, revealing a potential bottleneck at the north-side exit during peak hours. The model predicts a full evacuation time of 25 minutes, which is 5 minutes over the safety target. Recommendations include the installation of two additional automated gates and a public address system with multi-lingual support to streamline crowd movement. Staff training modules should also be updated to include advanced crowd management techniques under duress. This report concludes with a risk matrix and a prioritized action plan, aiming to establish Aluva station as a benchmark for climate-resilient urban infrastructure within the Kochi Metro network. A follow-up audit is scheduled for Q2 next year.</p>`,
            plan: `<p class="mb-4 text-gray-700 leading-relaxed">The integration of the Palarivattom Metro Station with the rebuilt Palarivattom Flyover represents a landmark urban mobility project. This document details the architectural, logistical, and traffic management plan designed to create a seamless multi-modal transit experience. The core objective is to facilitate effortless pedestrian flow between the metro concourse and the bus bays situated beneath the flyover, thereby reducing interchange time and improving commuter convenience.</p><p class="mb-4 text-gray-700 leading-relaxed">Key features of the integration include a 150-meter climate-controlled skywalk connecting the station's ticketing level directly to the flyover's pedestrian walkway. This structure will be equipped with travelators and will be fully accessible, complying with all ADA standards. The design incorporates transparent, impact-resistant polycarbonate panels to offer panoramic views while ensuring safety and weather protection. The estimated cost for the skywalk is ₹8.5 Crore, with a construction timeline of 18 months.</p><p class="mb-4 text-gray-700 leading-relaxed">Traffic flow analysis, conducted using Vissim software, projects a 30% reduction in local traffic congestion upon completion. The plan introduces dedicated bus lanes, intelligent traffic signaling synchronized with metro arrivals, and designated drop-off zones for auto-rickshaws and ride-sharing services. Appendix B contains the detailed traffic simulation models. The final phase involves landscaping and urban beautification of the surrounding area, creating a green public plaza. This holistic approach ensures that the Palarivattom interchange becomes not just a transit point, but a well-designed urban space that enhances the local environment and promotes public transportation usage.</p>`,
            legal: `<p class="mb-4 text-gray-700 leading-relaxed">This document constitutes the official lease agreement between the Kochi Metro Rail Limited (KMRL) and the Board of Trustees for Maharaja's College, concerning the parcel of land adjacent to the college grounds utilized for the construction and operation of the Maharaja's College Metro Station. The lease is granted for a period of 99 years, commencing from January 1, 2015.</p><p class="mb-4 text-gray-700 leading-relaxed">KMRL is granted exclusive rights to the surface and subsurface area as detailed in the cadastral map (Annexure I) for all activities related to the metro station, including but not limited to construction, maintenance, operations, and commercial development within the station premises. The agreement stipulates an annual lease payment of ₹50 Lakhs, subject to a 10% upward revision every three years. Furthermore, KMRL commits to undertake the complete restoration and landscaping of any part of the college grounds temporarily affected during the construction phase.</p><p class="mb-4 text-gray-700 leading-relaxed">A key provision of this agreement is the commitment from KMRL to build and maintain a dedicated, secure walkway for students from the college campus to the station entrance. Additionally, KMRL will offer a 30% concession on metro smart cards for all registered students and faculty of Maharaja's College. The Board of Trustees retains the right to approve the aesthetic design of the station facade facing the college to ensure it remains harmonious with the heritage architecture of the campus. Any disputes arising from this agreement will be subject to arbitration as per the Arbitration and Conciliation Act, 1996, with the jurisdiction resting in Ernakulam.</p>`,
        };
        
        const stations = [
            { id: 1, name: 'Aluva', coords: [10.1032, 76.3518] },
            { id: 2, name: 'Palarivattom', coords: [10.0075, 76.3101] },
            { id: 3, name: 'Maharaja\'s College', coords: [9.9722, 76.2861] },
            { id: 4, name: 'Vyttila', coords: [9.9734, 76.3148] },
            { id: 5, name: 'Thykoodam', coords: [9.9634, 76.3175] },
            { id: 6, name: 'Pettah', coords: [9.9525, 76.3268] },
            { id: 7, name: 'SN Junction', coords: [9.9468, 76.3411] },
            { id: 8, name: 'Tripunithura Terminal', coords: [9.9465, 76.3532] }
        ];

        const documents = [
            { id: 101, stationId: 1, title: 'Aluva Station Flood Preparedness Report', type: 'PDF', date: '2025-09-27', content: longContent.report },
            { id: 102, stationId: 1, title: 'Feeder Service Schedule - Aluva', type: 'XLSX', date: '2025-09-15', content: longContent.plan },
            { id: 103, stationId: 2, title: 'Palarivattom Flyover Integration Plan', type: 'DOCX', date: '2025-08-01', content: longContent.plan },
            { id: 104, stationId: 3, title: 'Maharaja\'s College Ground Lease Agreement', type: 'PDF', date: '2025-07-22', content: longContent.legal },
            { id: 105, stationId: 4, title: 'Vyttila Mobility Hub Advertising Revenue', type: 'Log', date: '2025-09-25', content: longContent.report },
            { id: 106, stationId: 4, title: 'Water Metro Connectivity Report - Vyttila', type: 'PPTX', date: '2025-06-11', content: longContent.plan },
            { id: 107, stationId: 5, title: 'Thykoodam Bridge Maintenance Log', type: 'PDF', date: '2025-09-02', content: longContent.legal },
            { id: 108, stationId: 6, title: 'Pettah Station Passenger Flow Analysis', type: 'DOCX', date: '2025-05-19', content: longContent.report },
            { id: 109, stationId: 7, title: 'SN Junction Land Acquisition Documents', type: 'XLSX', date: '2025-04-30', content: longContent.legal },
            { id: 110, stationId: 8, title: 'Tripunithura Terminal Inauguration Plan', type: 'PDF', date: '2025-09-10', content: longContent.plan }
        ];
        
        const generateRoute = (stations) => {
            const route = [];
            for (let i = 0; i < stations.length - 1; i++) {
                const start = L.latLng(stations[i].coords);
                const end = L.latLng(stations[i + 1].coords);
                const distance = start.distanceTo(end);
                // Increased points for a smoother path
                const steps = Math.max(20, distance / 40); 

                for (let j = 0; j <= steps; j++) {
                    const lat = start.lat + (end.lat - start.lat) * (j / steps);
                    const lng = start.lng + (end.lng - start.lng) * (j / steps);
                    route.push([lat, lng]);
                }
            }
            return route;
        };
        const trackCoords = generateRoute(stations);

        // --- MAP INITIALIZATION ---
        const map = L.map('map', { zoomControl: false }).setView([9.98, 76.32], 13);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- UI ELEMENTS ---
        const sidePanelHeader = document.getElementById('side-panel-header');
        const sidePanelContent = document.getElementById('side-panel-content');
        const toggleTrainBtn = document.getElementById('toggle-train-btn');
        const trainBtnText = document.getElementById('train-btn-text');
        const trainBtnIcon = document.getElementById('train-btn-icon');
        const resetViewBtn = document.getElementById('reset-view-btn');
        const modal = document.getElementById('document-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalOverlay = document.getElementById('modal-overlay');

        const fileIcons = {
            'PDF': { icon: 'fa-file-pdf', color: 'text-red-500' },
            'XLSX': { icon: 'fa-file-excel', color: 'text-green-500' },
            'DOCX': { icon: 'fa-file-word', color: 'text-blue-500' },
            'PPTX': { icon: 'fa-file-powerpoint', color: 'text-orange-500' },
            'Log': { icon: 'fa-file-csv', color: 'text-yellow-500' }
        };
        let activeStationId = null;
        const stationMarkers = {};
        
        // --- CORE UI RENDERING FUNCTIONS ---
        const renderStationOverview = () => {
            sidePanelHeader.innerHTML = `
                <div class="flex items-center gap-4">
                    <i class="fa-solid fa-list-check text-3xl text-blue-300"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Station Overview</h1>
                        <p class="text-gray-300 mt-1">${stations.length} Stations | ${documents.length} Total Documents</p>
                    </div>
                </div>`;
            
            sidePanelContent.innerHTML = stations.map(station => {
                const docCount = documents.filter(d => d.stationId === station.id).length;
                return `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 mb-3 hover:border-blue-500 hover:shadow-lg cursor-pointer transition-all transform hover:-translate-y-1" onclick="selectStation(${station.id})">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-lg text-gray-800">${station.name}</h3>
                            <div class="bg-blue-100 text-blue-800 text-sm font-bold px-3 py-1 rounded-full">${docCount} Documents</div>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        const renderDocumentView = (stationId) => {
            const station = stations.find(s => s.id === stationId);
            const docsToRender = documents.filter(doc => doc.stationId === stationId);
            const docCountsByType = docsToRender.reduce((acc, doc) => {
                acc[doc.type] = (acc[doc.type] || 0) + 1;
                return acc;
            }, {});

            sidePanelHeader.innerHTML = `
                <div class="flex items-center gap-4">
                    <i class="fa-solid fa-folder-open text-3xl text-blue-300"></i>
                    <div>
                        <h1 class="text-2xl font-bold">${station.name}</h1>
                        <p class="text-gray-300 mt-1">Viewing Documents</p>
                    </div>
                </div>`;
            
            sidePanelContent.innerHTML = `
                <details class="bg-white border rounded-xl mb-4" open>
                    <summary class="font-semibold text-gray-700 p-3 cursor-pointer">Metrics</summary>
                    <div class="p-3 border-t">
                        <p class="mb-2"><strong>Total Documents:</strong> ${docsToRender.length}</p>
                        <ul class="list-disc list-inside text-gray-600">
                            ${Object.entries(docCountsByType).map(([type, count]) => `<li>${type}: ${count}</li>`).join('')}
                        </ul>
                    </div>
                </details>
                ${docsToRender.map(doc => {
                    const iconInfo = fileIcons[doc.type] || { icon: 'fa-file-lines', color: 'text-gray-500' };
                    return `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 mb-3 hover:border-blue-500 hover:shadow-lg cursor-pointer transition-all" onclick="openDocumentModalById(${doc.id})">
                        <div class="flex items-center">
                            <i class="fa-solid ${iconInfo.icon} ${iconInfo.color} text-3xl mr-4 w-8 text-center"></i>
                            <div>
                                <h3 class="font-semibold text-gray-800 leading-tight">${doc.title}</h3>
                                <p class="text-sm text-gray-500">Added on: ${doc.date}</p>
                            </div>
                        </div>
                    </div>`;
                }).join('') || `<div class="text-center text-gray-500 p-8">No documents found.</div>`}
            `;
        };

        const openDocumentModal = (doc) => {
            modalTitle.textContent = doc.title;
            modalBody.innerHTML = doc.content;
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
        };

        const closeDocumentModal = () => {
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-visible');
        };
        
        const openDocumentModalById = (docId) => {
            const doc = documents.find(d => d.id === docId);
            if (doc) openDocumentModal(doc);
        };
        
        const selectStation = (stationId) => {
            if (activeStationId && stationMarkers[activeStationId]) {
                stationMarkers[activeStationId].getElement().classList.remove('active-station-icon');
            }
            
            if(stationId === null) { // Reset view
                activeStationId = null;
                renderStationOverview();
                map.flyTo([9.98, 76.32], 13);
                return;
            }

            activeStationId = stationId;
            const station = stations.find(s => s.id === stationId);
            if(stationMarkers[stationId]) {
                stationMarkers[stationId].getElement().classList.add('active-station-icon');
                map.flyTo(station.coords, 15);
            }
            renderDocumentView(stationId);
        };

        // --- MAP FEATURES ---
        const trackLine = L.polyline(trackCoords, { color: '#005a9c', weight: 8, opacity: 0.85, lineCap: 'round', lineJoin: 'round' }).addTo(map);

        stations.forEach(station => {
            const icon = L.divIcon({ className: 'station-icon', html: '' });
            const marker = L.marker(station.coords, { icon: icon }).addTo(map).bindPopup(station.name);
            marker.on('click', () => selectStation(station.id));
            stationMarkers[station.id] = marker;
        });

        // --- TRAIN ANIMATION LOGIC ---
        const trainIcon = L.divIcon({
            className: 'train-fa-icon',
            html: `<i class="fa-solid fa-train-tram"></i>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
        const trainMarker = L.marker(stations[0].coords, { icon: trainIcon, zIndexOffset: 1000 }).addTo(map);

        let simulationState = 'stopped'; // 'stopped', 'running', 'paused'
        let animationFrameId = null;
        let stationPauseTimeoutId = null;
        let currentTrackIndex = 0;
        const stationPauseDuration = 2000; // 2 seconds
        const animationStep = 2; // Use an integer for smooth stepping

        const animateTrain = () => {
            const nextIndex = currentTrackIndex + animationStep;

            if (nextIndex >= trackCoords.length) {
                trainMarker.setLatLng(trackCoords[trackCoords.length - 1]);
                stopSimulation(); 
                selectStation(null);
                return;
            }
            
            currentTrackIndex = nextIndex;
            const nextPos = trackCoords[currentTrackIndex];
            trainMarker.setLatLng(nextPos);

            const stationAtLocation = stations.find(s => L.latLng(s.coords).distanceTo(L.latLng(nextPos)) < 150);

            if (stationAtLocation && stationAtLocation.id !== activeStationId) {
                selectStation(stationAtLocation.id);
                pauseSimulation();
                stationPauseTimeoutId = setTimeout(resumeSimulation, stationPauseDuration);
            } else {
                animationFrameId = requestAnimationFrame(animateTrain);
            }
        };

        const updateButtonUI = (state) => {
            switch(state) {
                case 'running':
                    trainBtnText.textContent = 'Running...';
                    trainBtnIcon.className = 'fa-solid fa-spinner fa-spin w-5 text-center';
                    toggleTrainBtn.classList.replace('bg-blue-600', 'bg-red-600');
                    toggleTrainBtn.classList.replace('hover:bg-blue-700', 'hover:bg-red-700');
                    break;
                case 'paused':
                    trainBtnText.textContent = 'Paused';
                    trainBtnIcon.className = 'fa-solid fa-pause w-5 text-center';
                    break;
                case 'stopped':
                    trainBtnText.textContent = 'Start Simulation';
                    trainBtnIcon.className = 'fa-solid fa-play w-5 text-center';
                    toggleTrainBtn.classList.replace('bg-red-600', 'bg-blue-600');
                    toggleTrainBtn.classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
                    break;
            }
        }
        
        const startSimulation = () => {
            simulationState = 'running';
            if (currentTrackIndex >= trackCoords.length - 1) { 
                currentTrackIndex = 0;
                trainMarker.setLatLng(stations[0].coords);
            }
            selectStation(stations[0].id);
            updateButtonUI('running');
            setTimeout(() => { 
                animationFrameId = requestAnimationFrame(animateTrain); 
            }, 500);
        };

        const pauseSimulation = () => {
            simulationState = 'paused';
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
            updateButtonUI('paused');
        };

        const resumeSimulation = () => {
            simulationState = 'running';
            updateButtonUI('running');
            animationFrameId = requestAnimationFrame(animateTrain);
        };

        const stopSimulation = () => {
            simulationState = 'stopped';
            cancelAnimationFrame(animationFrameId);
            clearTimeout(stationPauseTimeoutId);
            animationFrameId = null;
            stationPauseTimeoutId = null;
            updateButtonUI('stopped');
        };
        
        // --- EVENT LISTENERS ---
        toggleTrainBtn.addEventListener('click', () => {
            if (simulationState === 'running' || simulationState === 'paused') {
                stopSimulation();
                selectStation(null); // Reset to overview when stopping
            } else {
                startSimulation();
            }
        });

        resetViewBtn.addEventListener('click', () => {
            stopSimulation();
            currentTrackIndex = 0;
            trainMarker.setLatLng(stations[0].coords);
            selectStation(null);
        });

        modalCloseBtn.addEventListener('click', closeDocumentModal);
        modalOverlay.addEventListener('click', closeDocumentModal);

        // --- INITIAL LOAD ---
        renderStationOverview();
        
    </script>
</body>
</html>

